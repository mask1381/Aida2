import google.generativeai
print(f"VERSION CHECK: {google.generativeai.__version__}")
import os
import re
import io
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import (Application, CommandHandler, MessageHandler, filters,
                          CallbackContext, CallbackQueryHandler, ConversationHandler)
import google.generativeai as genai

# ---------- Û±. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ ----------
# (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
try:
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID"))
    GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
    if not all([BOT_TOKEN, ADMIN_USER_ID, GEMINI_API_KEY]):
        raise ValueError("ÛŒÚ©ÛŒ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø­ÛŒØ§ØªÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
except (ValueError, TypeError) as e:
    print(f"Ø®Ø·Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ: Ù„Ø·ÙØ§ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯. Ø®Ø·Ø§: {e}")
    exit()

SETTINGS_FILE = "settings.json"
FONT_FILE = "Vazirmatn-Regular.ttf"
FONT_SIZE = 30

# ---------- Û². Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Gemini ----------
# (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
try:
    genai.configure(api_key=GEMINI_API_KEY)
    model = genai.GenerativeModel('gemini-pro')
    print("Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Gemini Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¯.")
except Exception as e:
    print(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Gemini: {e}")
    exit()


# ---------- Û³. ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡ (settings.json) ----------
# (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
def load_settings():
    try:
        with open(SETTINGS_FILE, 'r') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        default_settings = {
            "defaults": { "max_hashtags": 3, "hashtags_enabled": True, "signature_enabled": True, "watermark_enabled": True, "show_channel_id": True },
            "registered_channels": {}, "custom_commands": {}
        }
        save_settings(default_settings)
        return default_settings

def save_settings(settings_data):
    with open(SETTINGS_FILE, 'w') as f:
        json.dump(settings_data, f, indent=2)

# ---------- Û´. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø§ØµÙ„ÛŒ ----------
# (ØªÙˆØ§Ø¨Ø¹ escape_markdown, apply_watermark Ùˆ... Ø¨Ø§ Ú©Ù…ÛŒ ØªØºÛŒÛŒØ±)
def escape_markdown(text: str) -> str:
    # ... (Ú©Ø¯ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    escape_chars = r'_*[]()~`>#+-=|{}.!'
    return re.sub(f'([{re.escape(escape_chars)}])', r'\\\1', text)

def apply_watermark(file_bytes: bytes, watermark_text: str) -> bytes:
    # ... (Ú©Ø¯ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    try:
        with Image.open(io.BytesIO(file_bytes)).convert("RGBA") as base:
            txt = Image.new("RGBA", base.size, (255, 255, 255, 0))
            font = ImageFont.truetype(FONT_FILE, FONT_SIZE)
            draw = ImageDraw.Draw(txt)
            bbox = font.getbbox(watermark_text)
            text_width, text_height = bbox[2] - bbox[0], bbox[3] - bbox[1]
            margin = 20
            x, y = base.size[0] - text_width - margin, base.size[1] - text_height - margin
            draw.text((x, y), watermark_text, font=font, fill=(255, 255, 255, 128))
            out = Image.alpha_composite(base, txt)
            buffer = io.BytesIO()
            out.convert("RGB").save(buffer, "JPEG")
            buffer.seek(0)
            return buffer.getvalue()
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©: {e}")
        return file_bytes

async def analyze_post_intent(user_text: str, settings: dict) -> dict:
    """Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒØŒ Ù…Ù†Ø¸ÙˆØ± Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ† Ù¾Ø³Øª Ø®Ø§Øµ Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯"""
    prompt = f"""
    ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ ÛŒÚ© Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ù¾Ø³Øª Ú©Ù†Ø¯.
    Ù…ØªÙ† Ø¯Ø³ØªÙˆØ± Ø§Ùˆ Ø§ÛŒÙ† Ø§Ø³Øª: "{user_text}"
    ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø¨Ø§Øª Ø§ÛŒÙ† Ø§Ø³Øª: {json.dumps(settings['defaults'])}

    Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ø¨Ø±ØŒ ØªØ­Ù„ÛŒÙ„ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø§Ùˆ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø¨Ø±Ø§ÛŒ *Ø§ÛŒÙ† Ù¾Ø³Øª Ø®Ø§Øµ* ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯ ÛŒØ§ Ù†Ù‡.
    Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ ÙÙ‚Ø· Ø¨Ù‡ ØµÙˆØ±Øª ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª JSON Ø¨Ø¯Ù‡ Ú©Ù‡ Ø´Ø§Ù…Ù„ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ø§Ø´Ø¯:
    - "hashtags_enabled": boolean
    - "signature_enabled": boolean
    - "watermark_enabled": boolean
    - "show_channel_id": boolean
    - "generate_new_caption": "ÛŒÚ© Ú©Ù¾Ø´Ù† Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§ Ùˆ Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ø¨Ø± Ø¨Ù†ÙˆÛŒØ³"

    Ù…Ø«Ø§Ù„: Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ú¯ÙØª "Ø§ÛŒÙ† Ø±Ùˆ Ø¨Ø¯ÙˆÙ† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ùˆ Ø§Ù…Ø¶Ø§ Ø¨ÙØ±Ø³Øª"ØŒ Ù…Ù‚Ø¯Ø§Ø± watermark_enabled Ùˆ signature_enabled Ø¨Ø§ÛŒØ¯ false Ø¨Ø§Ø´Ø¯.
    Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· Ú¯ÙØª "/post"ØŒ ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ú¯ÛŒØ±.
    """
    try:
        response = model.generate_content(prompt)
        # ØªÙ…ÛŒØ² Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙØ±Ù…Øª ØµØ­ÛŒØ­ JSON
        cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
        return json.loads(cleaned_response)
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ù…Ù†Ø¸ÙˆØ± Ú©Ø§Ø±Ø¨Ø±: {e}")
        return settings['defaults'] # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†


# ---------- Ûµ. ØªØ¹Ø±ÛŒÙ Handlers Ùˆ Conversation ----------

# --- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„ ---
async def add_channel_command(update: Update, context: CallbackContext):
    if update.message.from_user.id != ADMIN_USER_ID: return
    try:
        channel_id = context.args[0]
        settings = load_settings()
        settings['registered_channels'][channel_id] = channel_id # Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª key: value
        save_settings(settings)
        await update.message.reply_text(f"âœ… Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
    except IndexError:
        await update.message.reply_text("Ø§Ø³ØªÙØ§Ø¯Ù‡: /addchannel @username_or_id")

# --- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶) ---
async def chat_handler(update: Update, context: CallbackContext):
    if update.message.from_user.id != ADMIN_USER_ID: return
    user_message = update.message.text
    processing_msg = await update.message.reply_text("ğŸ¤”...")
    try:
        response = model.generate_content(user_message)
        await processing_msg.edit_text(response.text)
    except Exception as e:
        await processing_msg.edit_text(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: {e}")


# --- Ù…Ú©Ø§Ù„Ù…Ù‡ Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª ---
SELECTING_CHANNEL = range(1)

async def post_command(update: Update, context: CallbackContext):
    """Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„: Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª"""
    if update.message.from_user.id != ADMIN_USER_ID: return
    
    replied_message = update.message.reply_to_message
    if not replied_message:
        await update.message.reply_text("Ù„Ø·ÙØ§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ØŒ Ø±ÙˆÛŒ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± /post Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯.")
        return ConversationHandler.END

    # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
    context.user_data['message_to_post'] = replied_message
    context.user_data['post_command_text'] = update.message.text # Ù…ØªÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ø¨Ø± (Ù…Ø«Ù„Ø§ /post Ø§ÛŒÙ†Ùˆ Ø¨Ø¯ÙˆÙ† Ù‡Ø´ØªÚ¯ Ø¨ÙØ±Ø³Øª)

    settings = load_settings()
    channels = settings.get('registered_channels', {})
    if not channels:
        await update.message.reply_text("Ù‡ÛŒÚ† Ú©Ø§Ù†Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª! Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ /addchannel ÛŒÚ© Ú©Ø§Ù†Ø§Ù„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.")
        return ConversationHandler.END

    keyboard = [[InlineKeyboardButton(ch, callback_data=ch)] for ch in channels.keys()]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text('Ù¾Ø³Øª Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ú©Ø§Ù†Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ', reply_markup=reply_markup)
    
    return SELECTING_CHANNEL


async def channel_selected(update: Update, context: CallbackContext):
    """Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: Ú©Ø§Ù†Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ØŒ Ø­Ø§Ù„Ø§ Ù¾Ø³Øª Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†"""
    query = update.callback_query
    await query.answer()
    
    target_channel = query.data
    message_to_post = context.user_data.get('message_to_post')
    post_command_text = context.user_data.get('post_command_text', "")
    
    await query.edit_message_text("â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø³Øª...")

    settings = load_settings()
    
    # ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ù†Ø¸ÙˆØ± Ú©Ø§Ø±Ø¨Ø±
    post_settings = await analyze_post_intent(post_command_text, settings)
    
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ
    original_caption = message_to_post.caption or message_to_post.text or ""
    photo_id = message_to_post.photo[-1].file_id if message_to_post.photo else None
    video_id = message_to_post.video.file_id if message_to_post.video else None
    
    # Ø³Ø§Ø®Øª Ú©Ù¾Ø´Ù† Ù†Ù‡Ø§ÛŒÛŒ
    new_caption = escape_markdown(post_settings.get("generate_new_caption", original_caption))
    
    # ØªÙˆÙ„ÛŒØ¯ Ù‡Ø´ØªÚ¯ (Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯)
    hashtags = ""
    if post_settings.get("hashtags_enabled", False):
        max_h = settings['defaults'].get("max_hashtags", 3)
        prompt = f"Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† Ø²ÛŒØ± Ø­Ø¯Ø§Ú©Ø«Ø± {max_h} Ù‡Ø´ØªÚ¯ Ø¨Ø³Ø§Ø²: {new_caption}"
        response = model.generate_content(prompt)
        hashtags = escape_markdown(" ".join([f"#{tag.strip()}" for tag in response.text.replace("#", "").split()]))

    # Ø³Ø§Ø®Øª Ø§Ù…Ø¶Ø§ (Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯)
    signature = ""
    if post_settings.get("signature_enabled", False):
        user = await context.bot.get_chat(ADMIN_USER_ID)
        sig_parts = [f"ğŸ‘¤ Ø§Ø±Ø³Ø§Ù„ ØªÙˆØ³Ø·: [{escape_markdown(user.first_name)}](tg://user?id={user.id})"]
        if post_settings.get("show_channel_id", False):
            sig_parts.append(f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ Ù…Ø§: {escape_markdown(target_channel)}")
        signature = "\n\n".join(sig_parts)

    full_caption = "\n\n".join(filter(None, [new_caption, hashtags, signature]))

    # Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ
    try:
        if photo_id:
            file = await context.bot.get_file(photo_id)
            photo_bytes = await file.download_as_bytearray()
            if post_settings.get("watermark_enabled", False):
                photo_bytes = apply_watermark(photo_bytes, f"{target_channel} Â©")
            await context.bot.send_photo(chat_id=target_channel, photo=photo_bytes, caption=full_caption, parse_mode=ParseMode.MARKDOWN_V2)
        elif video_id:
             await context.bot.send_video(chat_id=target_channel, video=video_id, caption=full_caption, parse_mode=ParseMode.MARKDOWN_V2)
        elif message_to_post.text:
            await context.bot.send_message(chat_id=target_channel, text=full_caption, parse_mode=ParseMode.MARKDOWN_V2)
            
        await query.edit_message_text("âœ… Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
    except Exception as e:
        await query.edit_message_text(f"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø±Ø® Ø¯Ø§Ø¯: {e}")

    return ConversationHandler.END


async def cancel_conversation(update: Update, context: CallbackContext):
    """Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª"""
    await update.message.reply_text('Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.')
    return ConversationHandler.END

# ---------- Û¶. Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ----------
def main():
    application = Application.builder().token(BOT_TOKEN).build()
    
    # ØªØ¹Ø±ÛŒÙ ConversationHandler Ø¨Ø±Ø§ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ /post
    post_conversation = ConversationHandler(
        entry_points=[CommandHandler('post', post_command)],
        states={
            SELECTING_CHANNEL: [CallbackQueryHandler(channel_selected)]
        },
        fallbacks=[CommandHandler('cancel', cancel_conversation)]
    )
    
    # Ø«Ø¨Øª Ú©Ø±Ø¯Ù† Handler Ù‡Ø§
    application.add_handler(post_conversation)
    application.add_handler(CommandHandler("addchannel", add_channel_command))
    
    # Handler Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙØªÚ¯Ùˆ (Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ³ØªÙ†Ø¯ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, chat_handler))

    print("Ø±Ø¨Ø§Øª Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø´Ù…Ø§ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯...")
    
    # (Ø§Ú¯Ø± Ø§Ø² Replit Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ø®Ø· keep_alive() Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯)
    # keep_alive()
    
    application.run_polling()

if __name__ == '__main__':
    main()
